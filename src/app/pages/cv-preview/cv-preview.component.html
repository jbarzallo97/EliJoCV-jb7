<div class="preview-container">
  <div class="preview-header mb-4">
    <h2 class="preview-title">Vista previa</h2>
    <p class="preview-subtitle">
      Completa tus datos y verás la información acá.
    </p>
  </div>

  <div class="preview-content" *ngIf="hasData(); else emptyState">
    <ng-container *ngIf="previewReady">
      <!-- Páginas A4 apiladas (como Word). El scroll es del panel, no de la hoja. -->
      <div class="cv-pages">
        <div class="a4-page" *ngFor="let p of pages; let pageIndex = index">
          <div class="a4-inner">
            <!-- Header SOLO en la primera página -->
            <ng-container *ngIf="pageIndex === 0">
              <div class="cv-first-page-header" #firstPageHeader>
                <!-- Header: Nombre, puesto y foto -->
                <div class="cv-header row align-items-center">
                  <div class="col-md-8">
                    <h1 class="cv-name">
                      {{ cvData.personalInfo.nombres }} {{ cvData.personalInfo.apellidos }}
                    </h1>
                    <p class="cv-position" *ngIf="cvData.personalInfo.puesto">
                      {{ cvData.personalInfo.puesto }}
                    </p>
                  </div>
                  <div class="col-md-4 text-md-end" *ngIf="cvData.personalInfo.foto">
                    <div class="cv-photo-wrapper d-inline-block">
                      <div class="cv-photo-circle">
                        <img [src]="cvData.personalInfo.foto" alt="Foto de perfil" class="cv-photo-img">
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Barra de contacto -->
                <div
                  class="cv-contact-bar mt-3"
                  *ngIf="
                    cvData.personalInfo.email ||
                    cvData.personalInfo.celular ||
                    cvData.personalInfo.ubicacion ||
                    cvData.personalInfo.nacionalidad ||
                    cvData.personalInfo.fechaNacimiento
                  ">
                  <div class="row text-center text-md-start gy-2">
                    <div class="col-md-4" *ngIf="cvData.personalInfo.email">
                      <span class="cv-contact-label">Email</span>
                      <span class="cv-contact-value">{{ cvData.personalInfo.email }}</span>
                    </div>
                    <div class="col-md-4" *ngIf="cvData.personalInfo.celular">
                      <span class="cv-contact-label">Número de teléfono</span>
                      <span class="cv-contact-value">{{ cvData.personalInfo.celular }}</span>
                    </div>
                    <div class="col-md-4" *ngIf="cvData.personalInfo.ubicacion">
                      <span class="cv-contact-label">Dirección</span>
                      <span class="cv-contact-value">{{ cvData.personalInfo.ubicacion }}</span>
                    </div>
                    <div class="col-md-4" *ngIf="cvData.personalInfo.nacionalidad">
                      <span class="cv-contact-label">Nacionalidad</span>
                      <span class="cv-contact-value">{{ cvData.personalInfo.nacionalidad }}</span>
                    </div>
                    <div class="col-md-4" *ngIf="cvData.personalInfo.fechaNacimiento">
                      <span class="cv-contact-label">Fecha de nacimiento</span>
                      <span class="cv-contact-value">{{ cvData.personalInfo.fechaNacimiento }}</span>
                    </div>
                    <div class="col-md-4" *ngIf="getAgeFromBirthDate(cvData.personalInfo.fechaNacimiento) !== null">
                      <span class="cv-contact-label">Edad</span>
                      <span class="cv-contact-value">
                        {{ getAgeFromBirthDate(cvData.personalInfo.fechaNacimiento) }} años
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

            <div class="row mt-4">
              <div class="col-lg-8 cv-page-left" #pageLeft></div>
              <div class="col-lg-4 cv-page-right" #pageRight></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Flujo oculto (fuente) para paginar: se reubican bloques, no se hacen scrolls internos. -->
      <div class="cv-flow" aria-hidden="true">
      <div class="a4-page cv-flow-page">
        <div class="a4-inner">
          <div class="row mt-4">
            <div class="col-lg-8 cv-flow-left" #flowLeft>
              <!-- Resumen Profesional -->
              <div class="cv-section" *ngIf="cvData.personalInfo.resumenProfesional" data-key="100">
                <h3 class="cv-section-title">Perfil</h3>
                <p>{{ cvData.personalInfo.resumenProfesional }}</p>
              </div>

              <!-- Experiencia profesional (paginable por trabajo) -->
              <ng-container *ngIf="cvData.workExperience.length > 0">
                <h3
                  class="cv-section-title"
                  data-key="200"
                  data-section="workExperience"
                  data-role="title">
                  Experiencia profesional
                </h3>

                <div
                  *ngFor="let exp of cvData.workExperience; let i = index; trackBy: trackById"
                  class="cv-item"
                  data-section="workExperience"
                  data-role="item"
                  [attr.data-key]="201 + i">
                  <h4>{{ exp.empresa }}</h4>
                  <p class="cv-item-meta">
                    <span class="fw-semibold">{{ exp.puesto }}</span>
                    <span *ngIf="exp.fechaInicio"> · {{ exp.fechaInicio }}</span>
                    <span *ngIf="exp.fechaFin && !exp.actualmenteTrabajando"> - {{ exp.fechaFin }}</span>
                    <span *ngIf="exp.actualmenteTrabajando"> - Actual</span>
                  </p>
                  <ng-container *ngIf="exp.descripcion">
                    <ul class="cv-bullet-list" *ngIf="formatBulletLines(exp.descripcion).length; else expPlainDesc">
                      <li *ngFor="let line of formatBulletLines(exp.descripcion)">
                        {{ line }}
                      </li>
                    </ul>
                    <ng-template #expPlainDesc>
                      <p>{{ exp.descripcion }}</p>
                    </ng-template>
                  </ng-container>
                </div>

                <div class="cv-section-spacer" data-key="299"></div>
              </ng-container>

              <!-- Educación -->
              <div class="cv-section" *ngIf="cvData.education.length > 0" data-key="300">
                <h3 class="cv-section-title">Educación</h3>
                <div *ngFor="let edu of cvData.education; trackBy: trackById" class="cv-item">
                  <h4>{{ edu.institucion }}</h4>
                  <p class="cv-item-meta">
                    <span class="fw-semibold">{{ edu.titulo }}</span>
                    <span *ngIf="edu.ubicacion"> · {{ edu.ubicacion }}</span>
                  </p>
                  <p class="cv-item-meta">
                    <span *ngIf="edu.fechaInicio"> {{ edu.fechaInicio }}</span>
                    <span *ngIf="edu.fechaFin && !edu.enCurso"> - {{ edu.fechaFin }}</span>
                    <span *ngIf="edu.enCurso"> · Actualmente estudiando</span>
                  </p>
                  <p class="cv-item-meta" *ngIf="edu.promedio">
                    Promedio (GPA): {{ edu.promedio }}
                  </p>
                  <ng-container *ngIf="edu.descripcion">
                    <ul class="cv-bullet-list" *ngIf="formatBulletLines(edu.descripcion).length; else eduPlainDesc">
                      <li *ngFor="let line of formatBulletLines(edu.descripcion)">
                        {{ line }}
                      </li>
                    </ul>
                    <ng-template #eduPlainDesc>
                      <p>{{ edu.descripcion }}</p>
                    </ng-template>
                  </ng-container>
                </div>
              </div>

            </div>

            <div class="col-lg-4 cv-flow-right" #flowRight>
              <!-- Idiomas -->
              <div class="cv-sidebar-section" *ngIf="cvData.languages.length > 0">
                <h3 class="cv-sidebar-title">Idiomas</h3>
                <div *ngFor="let lang of cvData.languages" class="cv-sidebar-item d-flex justify-content-between">
                  <span>{{ lang.idioma }}</span>
                  <span class="text-muted text-end text-capitalize">{{ lang.nivel }}</span>
                </div>
              </div>

              <!-- Habilidades -->
              <div class="cv-sidebar-section" *ngIf="cvData.skills.length > 0">
                <h3 class="cv-sidebar-title">Habilidades</h3>
                <div *ngFor="let skill of cvData.skills" class="cv-sidebar-item">
                  <div class="d-flex justify-content-between">
                    <span>{{ skill.nombre }}</span>
                    <small class="text-muted text-capitalize">{{ skill.nivel }}</small>
                  </div>
                  <small class="text-muted text-capitalize">{{ skill.categoria }}</small>
                </div>
              </div>

              <!-- Cursos -->
              <div class="cv-sidebar-section" *ngIf="cvData.courses.length > 0">
                <h3 class="cv-sidebar-title">Cursos</h3>
                <div *ngFor="let c of cvData.courses; trackBy: trackById" class="cv-sidebar-item">
                  <h4 class="cv-sidebar-item-title d-flex justify-content-between gap-2">
                    <span>{{ c.nombre }}</span>
                    <span class="text-muted" *ngIf="c.fecha">{{ c.fecha }}</span>
                  </h4>
                  <p class="cv-item-meta mb-1" *ngIf="c.institucion">{{ c.institucion }}</p>
                  <p class="mb-1" *ngIf="c.descripcion">{{ c.descripcion }}</p>
                  <a *ngIf="c.url" [href]="c.url" target="_blank" rel="noopener" class="cv-link d-inline-block">
                    {{ c.url }}
                  </a>
                </div>
              </div>

              <!-- Proyectos -->
              <div class="cv-sidebar-section" *ngIf="cvData.projects.length > 0">
                <h3 class="cv-sidebar-title">Proyectos</h3>
                <div *ngFor="let project of cvData.projects" class="cv-sidebar-item">
                  <h4 class="cv-sidebar-item-title d-flex justify-content-between gap-2">
                    <span>{{ project.nombre }}</span>
                    <span class="text-muted" *ngIf="project.fecha">{{ project.fecha }}</span>
                  </h4>
                  <div class="cv-item-meta" *ngIf="project.tecnologias?.length">
                    <!-- <span class="me-1">Tecnologías:</span> -->
                    <span class="d-inline-flex flex-wrap gap-1 align-items-center">
                      <span
                        *ngFor="let tech of project.tecnologias"
                        class="badge bg-secondary">
                        {{ tech }}
                      </span>
                    </span>
                  </div>
                  <p class="mb-1" *ngIf="project.descripcion">{{ project.descripcion }}</p>
                  <a *ngIf="project.url" [href]="project.url" target="_blank" rel="noopener" class="cv-link d-inline-block">
                    {{ project.url }}
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      </div>
    </ng-container>
  </div>

  <ng-template #emptyState>
    <div class="empty-preview">
      <div class="empty-preview-content">
        <i class="material-icons empty-icon">description</i>
        <p class="empty-text">Completa el formulario para ver la vista previa de tu CV</p>
      </div>
    </div>
  </ng-template>

  <!-- Botón de descarga -->
  <div class="preview-actions mt-4" *ngIf="hasData()">
    <button class="btn btn-primary btn-download" (click)="downloadCV()">
      <i class="material-icons">download</i>
      Descargar PDF
    </button>
  </div>
</div>
